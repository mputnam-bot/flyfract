<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FlyFract Deep Zoom Tests</title>
    <style>
        body {
            font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
            background: #1a1a2e;
            color: #eee;
            padding: 20px;
            max-width: 900px;
            margin: 0 auto;
        }
        h1 { color: #4fc3f7; }
        .test-output {
            background: #0d0d1a;
            padding: 15px;
            border-radius: 8px;
            white-space: pre-wrap;
            font-size: 14px;
            line-height: 1.5;
            max-height: 600px;
            overflow-y: auto;
        }
        .pass { color: #4caf50; }
        .fail { color: #f44336; }
        .warn { color: #ff9800; }
        button {
            background: #4fc3f7;
            color: #1a1a2e;
            border: none;
            padding: 12px 24px;
            font-size: 16px;
            border-radius: 6px;
            cursor: pointer;
            margin: 10px 5px 10px 0;
        }
        button:hover { background: #81d4fa; }
        .summary {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            font-size: 18px;
        }
        .summary.pass { background: #1b5e20; }
        .summary.fail { background: #b71c1c; }
        #canvas-container {
            margin-top: 20px;
            border: 1px solid #333;
            border-radius: 8px;
            overflow: hidden;
        }
        #test-canvas {
            width: 100%;
            height: 300px;
            display: block;
        }
    </style>
</head>
<body>
    <h1>FlyFract Deep Zoom Tests</h1>

    <button onclick="runTests()">Run All Tests</button>
    <button onclick="runVisualTest()">Run Visual Test</button>
    <button onclick="clearOutput()">Clear</button>

    <div id="output" class="test-output">Click "Run All Tests" to start...</div>

    <div id="summary" class="summary" style="display: none;"></div>

    <div id="canvas-container" style="display: none;">
        <canvas id="test-canvas"></canvas>
    </div>

    <script type="module">
        import { ReferenceOrbit, DeepZoomManager } from './js/core/reference-orbit.js';

        const output = document.getElementById('output');
        const summary = document.getElementById('summary');

        let passed = 0;
        let failed = 0;

        function log(msg, className = '') {
            const span = document.createElement('span');
            span.className = className;
            span.textContent = msg + '\n';
            output.appendChild(span);
            output.scrollTop = output.scrollHeight;
        }

        function assert(condition, message) {
            if (condition) {
                passed++;
                log(`✓ ${message}`, 'pass');
            } else {
                failed++;
                log(`✗ ${message}`, 'fail');
            }
        }

        function assertApprox(actual, expected, tolerance, message) {
            const diff = Math.abs(actual - expected);
            assert(diff <= tolerance, `${message} (expected ${expected}, got ${actual})`);
        }

        window.clearOutput = function() {
            output.textContent = '';
            summary.style.display = 'none';
            passed = 0;
            failed = 0;
        };

        window.runTests = async function() {
            clearOutput();
            log('═══════════════════════════════════════════');
            log('     DEEP ZOOM TEST SUITE');
            log('═══════════════════════════════════════════\n');

            // Test 1: Reference Orbit
            log('=== Test: Reference Orbit Computation ===\n');

            const orbit = new ReferenceOrbit();

            orbit.computeSync(2.0, 0, 10, 1000);
            assert(orbit.orbitLength < 10, `Point (2, 0) escapes quickly: ${orbit.orbitLength} iterations`);

            orbit.computeSync(-0.5, 0, 10, 1000);
            assert(orbit.orbitLength >= 500, `Point (-0.5, 0) stays bounded: ${orbit.orbitLength} iterations`);

            orbit.computeSync(-0.25, 0, 10, 1000);
            assert(orbit.orbitLength >= 500, `Point (-0.25, 0) in cardioid: ${orbit.orbitLength} iterations`);

            orbit.computeSync(0.5, 0.5, 10, 1000);
            assert(orbit.orbitLength > 0 && orbit.orbitLength < 100,
                `Point (0.5, 0.5) escapes quickly: ${orbit.orbitLength} iterations`);

            // Verify orbit values
            orbit.computeSync(-0.5, 0, 10, 100);
            assert(orbit.orbitRe[0] === 0 && orbit.orbitIm[0] === 0, 'First point is z=0');
            assertApprox(orbit.orbitRe[1], -0.5, 0.0001, 'Second point re=-0.5');
            assertApprox(orbit.orbitRe[2], -0.25, 0.0001, 'Third point re=-0.25');

            // Test 2: Threshold
            log('\n=== Test: Deep Zoom Threshold ===\n');

            assert(!ReferenceOrbit.shouldUseDeepZoom(5), 'zoomLog=5 (32x): no deep zoom');
            assert(!ReferenceOrbit.shouldUseDeepZoom(10), 'zoomLog=10 (1Kx): no deep zoom');
            assert(!ReferenceOrbit.shouldUseDeepZoom(13), 'zoomLog=13 (8Kx): no deep zoom');
            assert(ReferenceOrbit.shouldUseDeepZoom(14), 'zoomLog=14 (16Kx): deep zoom');
            assert(ReferenceOrbit.shouldUseDeepZoom(20), 'zoomLog=20 (1Mx): deep zoom');

            // Test 3: Performance
            log('\n=== Test: Performance ===\n');

            const iterations = 10000;
            const start = performance.now();
            orbit.computeSync(-0.5, 0, 30, iterations);
            const elapsed = performance.now() - start;

            log(`Computed ${orbit.orbitLength} iterations in ${elapsed.toFixed(2)}ms`);
            log(`Rate: ${(orbit.orbitLength / elapsed * 1000).toFixed(0)} iterations/second\n`);
            assert(elapsed < 1000, `Computation time < 1s: ${elapsed.toFixed(0)}ms`);

            // Test 4: WebGL texture (if available)
            log('\n=== Test: WebGL Texture ===\n');

            const canvas = document.getElementById('test-canvas');
            const gl = canvas.getContext('webgl');

            if (gl) {
                const ext = gl.getExtension('OES_texture_float');
                if (ext) {
                    log('OES_texture_float: available', 'pass');

                    orbit.computeSync(-0.5, 0, 20, 500);
                    const tex = orbit.createOrbitTexture(gl);

                    if (tex) {
                        assert(tex.texture !== null, 'Texture created');
                        assert(tex.width > 0, `Texture width: ${tex.width}`);
                        assert(tex.length === orbit.orbitLength, `Texture length matches: ${tex.length}`);
                        gl.deleteTexture(tex.texture);
                    } else {
                        log('Texture creation failed', 'fail');
                        failed++;
                    }
                } else {
                    log('OES_texture_float: NOT available', 'warn');
                    log('Deep zoom textures will not work on this device', 'warn');
                }
            } else {
                log('WebGL not available', 'warn');
            }

            // Summary
            log('\n═══════════════════════════════════════════');
            log(`  Results: ${passed} passed, ${failed} failed`);
            log('═══════════════════════════════════════════');

            summary.textContent = `${passed} passed, ${failed} failed`;
            summary.className = 'summary ' + (failed === 0 ? 'pass' : 'fail');
            summary.style.display = 'block';
        };

        window.runVisualTest = function() {
            clearOutput();
            log('=== Visual Test ===\n');
            log('Opening main app to test deep zoom visually...\n');
            log('Instructions:');
            log('1. Zoom in past 10Kx on the Mandelbrot set');
            log('2. Verify "deep" appears in zoom indicator');
            log('3. Verify the fractal renders correctly (not black/grey)');
            log('4. Verify smooth transitions when panning\n');

            window.open('index.html', '_blank');
        };
    </script>
</body>
</html>
